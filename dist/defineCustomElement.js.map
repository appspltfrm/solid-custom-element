{"version":3,"file":"defineCustomElement.js","sources":["../src/lib/defineCustomElement.tsx"],"sourcesContent":["import {AssignableType} from \"@co.mmons/js-utils/core\";\nimport {createRoot, createSignal} from \"solid-js\";\nimport {insert} from \"solid-js/web\";\nimport {CustomElementInterface} from \"./CustomElementInterface\";\nimport {CustomElementReactivePropConfig} from \"./CustomElementReactivePropConfig\";\nimport {birthmarkProp} from \"./internals/birthmarkProp\";\nimport {CallbackName} from \"./internals/CallbackName\";\nimport {callbacksProp} from \"./internals/callbacksProp\";\nimport {childrenProp} from \"./internals/childrenProp\";\nimport {fromAttributeValue} from \"./internals/fromAttributeValue\";\nimport {globalStylesProp} from \"./internals/globalStylesProp\";\nimport {InternalClass} from \"./internals/InternalClass\";\nimport {InternalInstance} from \"./internals/InternalInstance\";\nimport {preValuesProp} from \"./internals/preValuesProp\";\nimport {reactivePropsProp} from \"./internals/reactivePropsProp\";\nimport {stylesProp} from \"./internals/stylesProp\";\nimport {toAttributeName} from \"./internals/toAttributeName\";\nimport {toAttributeValue} from \"./internals/toAttributeValue\";\n\nexport function defineCustomElement(tagName: string, ElementClass: AssignableType<HTMLElement & CustomElementInterface> & {[birthmarkProp]: true}) {\n\n    const internalClass = ElementClass as unknown as InternalClass;\n\n    const finalClass = class CustomElementFinal extends ElementClass {\n\n        static get observedAttributes() {\n            const props = internalClass[reactivePropsProp];\n            return Object.values(props).map(p => p.attribute);\n        }\n\n        constructor() {\n            super();\n        }\n\n        #initialized = false;\n\n        connectedCallback() {\n\n            const internalThis = this as unknown as HTMLElement & InternalInstance & CustomElementInterface;\n\n            if (this.#initialized) {\n                return;\n            }\n\n            this.#initialized = true;\n\n            initReactiveProps(internalThis, internalClass);\n            internalThis[preValuesProp] = undefined;\n\n            super.connectedCallback!();\n\n            createRoot((dispose: Function) => {\n\n                this.addDisconnectedCallback(() => {\n                    this.renderRoot.textContent = \"\";\n                    dispose();\n                })\n\n                let template = super.template!({children: internalThis[childrenProp]});\n                if (template && internalClass[stylesProp] && this.renderRoot === this) {\n                    template = <><style innerHTML={internalClass[stylesProp].join(\"\\n\")}/>{template}</>\n                }\n\n                return insert(this.renderRoot, template);\n            }, lookupContext(this));\n        }\n\n        async disconnectedCallback() {\n\n            // prevent premature releasing when element is only temporarily removed from DOM\n            await Promise.resolve();\n\n            if (this.isConnected) {\n                return;\n            }\n\n            const callbacks = (this as unknown as InternalInstance)[callbacksProp]!;\n\n            let callback = callbacks.pop();\n            while (callback) {\n\n                if (callback[0] === CallbackName.disconnected) {\n                    callback[1](this);\n                }\n\n                callback = callbacks.pop();\n            }\n\n            super.disconnectedCallback!();\n\n            this.#initialized = false;\n        }\n\n        attributeChangedCallback(name: string, oldVal: string, newVal: string) {\n\n            if (!this.#initialized) {\n                return;\n            }\n\n            const prop = lookupAttributeProp(name, internalClass)!;\n\n            if (newVal == null && !(this as any)[prop[0]]) {\n                return;\n            }\n\n            (this as any)[prop[0]] = fromAttributeValue(newVal, prop[1]);\n        }\n    }\n\n    const reactiveProps = (ElementClass as unknown as InternalClass)[reactivePropsProp];\n    for (let [propName, propDefinition] of Object.entries(reactiveProps)) {\n        if (!propDefinition.attribute) {\n            propDefinition.attribute = toAttributeName(propName);\n        }\n    }\n\n    if (internalClass[globalStylesProp]) {\n        for (const css of internalClass[globalStylesProp]) {\n            if (css) {\n                const head = document.head ?? document.querySelector(\"head\");\n                const style = document.createElement(\"style\")\n                style.appendChild(document.createTextNode(css));\n                head.appendChild(style);\n            }\n        }\n    }\n\n    customElements.define(tagName, finalClass)\n}\n\nfunction lookupContext(el: HTMLElement) {\n\n    type OwnerHost = {_$owner?: any}\n\n    if (el.assignedSlot && (el.assignedSlot as OwnerHost)._$owner) {\n        return (el.assignedSlot as OwnerHost)._$owner;\n    }\n\n    let next = el.parentNode;\n    while (next && !(next as OwnerHost)._$owner && !((next as Element).assignedSlot && ((next as Element).assignedSlot as OwnerHost)._$owner)) {\n        next = next.parentNode;\n    }\n\n    return next && (next as Element).assignedSlot ? ((next as Element).assignedSlot as OwnerHost)._$owner : (el as OwnerHost)._$owner;\n}\n\nfunction lookupAttributeProp(attributeName: string, elementClass: InternalClass): [propName: string, propDefinition: CustomElementReactivePropConfig] | undefined {\n    const props = elementClass[reactivePropsProp];\n    return Object.entries(props).find(([propName, prop]) => propName === attributeName || (prop as CustomElementReactivePropConfig).attribute === attributeName);\n}\n\nfunction initReactiveProps(element: HTMLElement & CustomElementInterface & InternalInstance, elementClass: InternalClass) {\n\n    const reactiveProps = elementClass[reactivePropsProp];\n    const names = [childrenProp, ...Object.keys(reactiveProps ?? {})];\n    const preValues = element[preValuesProp];\n\n    function firePropChange(propName: string, newVal: any, oldVal: any) {\n\n        const callbacks = element[callbacksProp];\n        for (let i = 0; i < callbacks.length; i++) {\n            if (callbacks[i][0] === CallbackName.propertyValueChange) {\n                try {\n                    callbacks[i][1](element, propName, newVal, oldVal);\n                } catch (e) {\n                    console.warn(\"CustomElement property value change callback error\", e);\n                }\n            }\n        }\n\n    }\n\n    function reflectAttribute(prop: CustomElementReactivePropConfig, value: any) {\n\n        const attr = prop.attribute!;\n        value = toAttributeValue(value, prop);\n\n        if (value === undefined || value === null || value === false) {\n            element.removeAttribute(attr);\n        } else {\n            const prev = element.getAttribute(attr);\n            if (prev !== value) {\n                element.setAttribute(attr, value);\n            }\n        }\n    }\n\n    for (let i = 0; i < names.length; i++) {\n\n        const propName = names[i];\n        const propConfig = reactiveProps[propName];\n\n        let initialValue = undefined;\n        if (preValues && propName in preValues) {\n            initialValue = preValues[propName];\n        } else {\n            initialValue = (element as any)[propName];\n        }\n\n        if (propConfig?.reflect) {\n            reflectAttribute(propConfig, initialValue);\n        }\n\n        const [get, set] = createSignal(initialValue);\n\n        Object.defineProperty(element, propName, {\n            get,\n            set(newVal: any) {\n                set((oldVal: any) => {\n\n                    if (propName !== childrenProp) {\n\n                        if (propConfig?.reflect) {\n                            reflectAttribute(propConfig, newVal);\n                        }\n\n                        firePropChange(propName, newVal, oldVal);\n                    }\n\n                    return newVal;\n                })\n            },\n            enumerable: true,\n            configurable: true\n        })\n    }\n\n\n}\n"],"names":["defineCustomElement","tagName","ElementClass","_initialized","internalClass","finalClass","_classPrivateFieldLooseKey","observedAttributes","props","reactivePropsProp","Object","values","map","p","attribute","constructor","connectedCallback","internalThis","_classPrivateFieldLooseBase","initReactiveProps","preValuesProp","undefined","createRoot","dispose","addDisconnectedCallback","renderRoot","textContent","template","children","childrenProp","stylesProp","_el$","_tmpl$","_$effect","join","insert","lookupContext","disconnectedCallback","Promise","resolve","isConnected","callbacks","callbacksProp","callback","pop","CallbackName","disconnected","attributeChangedCallback","name","oldVal","newVal","prop","lookupAttributeProp","fromAttributeValue","reactiveProps","propName","propDefinition","entries","toAttributeName","globalStylesProp","css","head","document","querySelector","style","createElement","appendChild","createTextNode","customElements","define","el","assignedSlot","_$owner","next","parentNode","attributeName","elementClass","find","element","names","keys","preValues","firePropChange","i","length","propertyValueChange","e","console","warn","reflectAttribute","value","attr","toAttributeValue","removeAttribute","getAttribute","setAttribute","propConfig","initialValue","reflect","get","set","createSignal","defineProperty","enumerable","configurable"],"mappings":"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"}