{"version":3,"file":"vars.js","sources":["../src/lib/vars.ts"],"sourcesContent":["import {createMemo, createSignal, Signal} from \"solid-js\";\nimport {createStore, Store} from \"solid-js/store\";\nimport {Accessor, EffectFunction, MemoOptions, NoInfer} from \"solid-js/types/reactive/signal\";\nimport {Observer, Unsubscribable} from \"type-fest\";\nimport {CustomElement} from \"./customElement\";\n\ntype Vars = {[key: string | symbol]: any};\ntype VarName = string | symbol;\n\nexport interface ObservableLike<ValueType = unknown> {\n    subscribe(observer?: Partial<Observer<ValueType>>): Unsubscribable;\n}\n\nconst allVars = new WeakMap<CustomElement, Vars>()\n\nclass VarValue {\n    value: any;\n    onDelete?: () => void;\n}\n\nfunction assertNotExists(vars: Vars | undefined, name: VarName) {\n    if (vars && name in vars) {\n        throw new Error(`Element var ${String(name)} already exists`);\n    }\n}\n\nfunction assertExists(vars: Vars | undefined, name: VarName) {\n    if (vars && !(name in vars)) {\n        throw new Error(`Element var ${String(name)} not exists`);\n    }\n}\n\nexport function getElementVar<T>(element: CustomElement, name: VarName): T | undefined {\n    const v = allVars.get(element)?.[name];\n    if (v instanceof VarValue) {\n        return v.value;\n    } else {\n        return v;\n    }\n}\n\nexport function createElementVar<T>(element: CustomElement, name: VarName, value: T, options?: {onDelete?: (() => any | void)}): T {\n    assertNotExists(allVars.get(element), name);\n    setElementVar(element, name, value, options);\n    return value;\n}\n\nexport function setElementVar(element: CustomElement, name: VarName, value: any, options?: {onDelete?: (() => any | void)}) {\n\n    let vars = allVars.get(element);\n    if (!vars) {\n        vars = {};\n        allVars.set(element, vars);\n\n        element.addDisconnectedCallback(() => {\n\n            const vars = allVars.get(element);\n            if (vars) {\n                for (const v of Object.values(vars)) {\n                    if (v instanceof VarValue) {\n                        v.onDelete?.();\n                    }\n                }\n            }\n\n            allVars.delete(element)\n        });\n    }\n\n    let varValue = value;\n    if (options?.onDelete) {\n        varValue = new VarValue();\n        varValue.value = value;\n        varValue.onDelete = options.onDelete;\n    }\n\n    vars[name] = varValue;\n}\n\nexport function deleteElementVar<T>(element: CustomElement, name: VarName): T | undefined {\n    const vars = allVars.get(element);\n    if (vars) {\n\n        let v = vars[name];\n        if (v instanceof VarValue) {\n            v.onDelete?.();\n            v = v.value;\n        }\n\n        delete vars[name];\n        return v;\n    }\n}\n\nexport function createElementMemo<Next extends Prev, Prev = Next>(element: CustomElement, name: VarName, fn: EffectFunction<undefined | NoInfer<Prev>, Next>): Accessor<Next>;\nexport function createElementMemo<Next extends Prev, Init = Next, Prev = Next>(element: CustomElement, name: VarName, fn: EffectFunction<Init | Prev, Next>, value: Init, options?: MemoOptions<Next>): Accessor<Next>;\n\nexport function createElementMemo<Next extends Prev, Init = Next, Prev = Next>(element: CustomElement, name: VarName, fn?: any, value?: Init, options?: MemoOptions<Next>): Accessor<Next> {\n\n    const vars = allVars.get(element);\n    assertNotExists(vars, name);\n\n    const memo = createMemo<Next, Init, Prev>(fn, value!, options);\n\n    setElementVar(element, name, memo);\n\n    return memo;\n}\n\nexport function useElementMemo<T = any>(element: CustomElement, name: VarName): Accessor<T> {\n\n    const vars = allVars.get(element);\n    assertExists(vars, name)\n\n    let value = vars![name];\n    if (value instanceof VarValue) {\n        value = value.value;\n    }\n\n    const memo = value as Accessor<T>;\n    if (typeof memo === \"function\") {\n        return memo;\n    }\n\n    return () => {\n        throw new Error(`Element var ${String(name)} is not a memo`);\n    }\n}\n\nexport function getElementMemo<T = any>(element: CustomElement, name: VarName): T {\n\n    let value = allVars.get(element)?.[name];\n    if (value instanceof VarValue) {\n        value = value.value;\n    }\n\n    const memo = value as Accessor<T>;\n    if (typeof memo === \"function\") {\n        return memo();\n    }\n\n    throw new Error(`Element var ${String(name)} is not a memo`);\n}\n\nexport function createElementSignal<T = any>(element: CustomElement, name: VarName, value?: T) {\n\n    const vars = allVars.get(element);\n    assertNotExists(vars, name);\n\n    const signal = createSignal(value);\n\n    setElementVar(element, name, signal);\n\n    return signal;\n}\n\nexport function useElementSignal<T = any>(element: CustomElement, name: VarName): Signal<T | undefined> {\n\n    let value = allVars.get(element)?.[name];\n    if (value instanceof VarValue) {\n        value = value.value;\n    }\n\n    let signal = value as Signal<T | undefined>;\n    if (!signal) {\n        signal = createElementSignal<T>(element, name);\n    }\n\n    return signal;\n}\n\nexport function getElementSignal<T = any>(element: CustomElement, name: VarName): T | undefined {\n\n    let value = allVars.get(element)?.[name];\n    if (value instanceof VarValue) {\n        value = value.value;\n    }\n\n    let signal = value as Signal<T | undefined>;\n    if (!signal) {\n        signal = createElementSignal(element, name);\n    }\n\n    return signal[0]();\n}\n\nexport function setElementSignal<T = any>(element: CustomElement, name: VarName, value: (prev: T | undefined) => T) {\n\n    let current = allVars.get(element)?.[name];\n    if (current instanceof VarValue) {\n        current = current.value;\n    }\n\n    let signal = current as Signal<T | undefined>;\n    if (!signal) {\n        signal = createElementSignal(element, name);\n    }\n\n    signal[1](value);\n}\n\nexport function deleteElementSignal(element: CustomElement, name: VarName) {\n    deleteElementVar(element, name);\n}\n\nexport function loadElementSignal<T = any>(element: CustomElement, name: VarName, observable: ObservableLike<T>, options?: {onError?: (error: any) => void}) {\n\n    const vars = allVars.get(element);\n    assertNotExists(vars, name);\n\n    const signal = createSignal<T>();\n\n    const unsub = observable.subscribe({\n        next: (data) => signal[1](() => data),\n        error: (error) => {\n            if (options?.onError) {\n                options.onError(error);\n            } else {\n                throw error;\n            }\n        }\n    })\n\n    setElementVar(element, name, signal, {onDelete: (\"unsubscribe\" in unsub ? unsub.unsubscribe : unsub)});\n\n    return signal[0];\n}\n\nexport function deleteElementStore(element: CustomElement, name: VarName) {\n    deleteElementVar(element, name);\n}\n\nexport function useElementStore<S extends {[key: string]: any}>(element: CustomElement, name: VarName): ReturnType<typeof createStore<S>> {\n\n    let value = allVars.get(element)?.[name];\n    if (value instanceof VarValue) {\n        value = value.value;\n    }\n\n    const store = value as ReturnType<typeof createStore<S>>;\n    if (store && Array.isArray(store)) {\n        return store;\n    } else {\n        return [\n            undefined as unknown as S,\n            (v: any) => {\n                const [, setStore] = createElementStore(element, name);\n                return setStore(v);\n            }\n        ] as ReturnType<typeof createStore<S>>;\n    }\n}\n\nexport function setElementStore<S extends {[key: string]: any}>(element: CustomElement, name: VarName, newValue: S){\n\n    let value = allVars.get(element)?.[name];\n    if (value instanceof VarValue) {\n        value = value.value;\n    }\n\n    const store = value as ReturnType<typeof createStore<S>>;\n    if (store && Array.isArray(store)) {\n        return store[1](newValue);\n    } else {\n        createElementStore(element, name, newValue);\n    }\n}\n\nexport function getElementStore<S extends {[key: string]: any}>(element: CustomElement, name: VarName): Store<S> {\n\n    let value = allVars.get(element)?.[name];\n    if (value instanceof VarValue) {\n        value = value.value;\n    }\n\n    const store = value as ReturnType<typeof createStore<S>>;\n    if (store && Array.isArray(store)) {\n        return store[0];\n    } else {\n        return undefined as unknown as Store<S>;\n    }\n}\n\nexport function createElementStore<S extends {[key: string]: any}>(element: CustomElement, name: VarName, value?: S) {\n\n    const vars = allVars.get(element);\n    assertNotExists(vars, name);\n\n    const store = createStore(value);\n\n    setElementVar(element, name, store);\n\n    return store;\n}\n\nexport function loadElementStore<S extends {[key: string]: any}>(element: CustomElement, name: VarName, value: ObservableLike<S>, options?: {onError?: (error: any) => void}) {\n\n    const vars = allVars.get(element);\n    assertNotExists(vars, name);\n\n    const store = createStore<S>({} as any);\n\n    const unsub = value.subscribe({\n        next: (data) => store[1](data),\n        error: (error) => {\n            if (options?.onError) {\n                options.onError(error);\n            } else {\n                throw error;\n            }\n        }\n    })\n\n    setElementVar(element, name, store, {onDelete: () => {\n        if (\"unsubscribe\" in unsub) {\n            unsub.unsubscribe();\n        }\n    }});\n\n    return store[0];\n}\n"],"names":["vars"],"mappings":"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"}