{"version":3,"file":"buildFinalClass.js","sources":["../../src/lib/internals/buildFinalClass.tsx"],"sourcesContent":["import {AssignableType} from \"@co.mmons/js-utils/core\";\nimport {createRoot, createSignal, getOwner} from \"solid-js\";\nimport {insert} from \"solid-js/web\";\nimport {CustomElement} from \"../customElement\";\nimport {CustomElementBirthmark} from \"../customElementBirthmark\";\nimport {CustomElementInterface} from \"../CustomElementInterface\";\nimport {CustomElementReactivePropConfig} from \"../CustomElementReactivePropConfig\";\nimport {CallbackName} from \"./CallbackName\";\nimport {callbacksProp} from \"./callbacksProp\";\nimport {childrenProp} from \"./childrenProp\";\nimport {fromAttributeValue} from \"./fromAttributeValue\";\nimport {globalStylesProp} from \"./globalStylesProp\";\nimport {InternalClass} from \"./InternalClass\";\nimport {InternalInstance} from \"./InternalInstance\";\nimport {ownerProp} from \"./ownerProp\";\nimport {preValuesProp} from \"./preValuesProp\";\nimport {reactivePropsProp} from \"./reactivePropsProp\";\nimport {stylesProp} from \"./stylesProp\";\nimport {toAttributeName} from \"./toAttributeName\";\nimport {toAttributeValue} from \"./toAttributeValue\";\n\nexport function buildFinalClass(ElementClass: AssignableType<CustomElement> & CustomElementBirthmark): typeof ElementClass {\n\n    const internalClass = ElementClass as unknown as InternalClass;\n\n    const finalClass = class CustomElementFinal extends ElementClass {\n\n        static get observedAttributes() {\n            const props = internalClass[reactivePropsProp];\n            return Object.values(props).map(p => p.attribute);\n        }\n\n        constructor() {\n            super();\n        }\n\n        #initialized = false;\n\n        connectedCallback() {\n\n            const internalThis = this as unknown as HTMLElement & InternalInstance & CustomElementInterface;\n\n            if (this.#initialized) {\n                return;\n            }\n\n            this.#initialized = true;\n\n            initReactiveProps(internalThis, internalClass);\n            internalThis[preValuesProp] = undefined;\n\n            super.connectedCallback!();\n\n            createRoot((dispose: Function) => {\n\n                this.addDisconnectedCallback(() => {\n                    this.renderRoot.textContent = \"\";\n                    dispose();\n                    delete internalThis[ownerProp];\n                })\n\n                let template = super.template!({children: internalThis[childrenProp]});\n                if (template && internalClass[stylesProp] && this.renderRoot !== this) {\n                    template = <><style innerHTML={internalClass[stylesProp].join(\"\\n\")}/>{template}</>\n                }\n\n                internalThis[ownerProp] = getOwner()!;\n\n                return insert(this.renderRoot, template);\n            }, lookupContext(this));\n        }\n\n        async disconnectedCallback() {\n\n            // prevent premature releasing when element is only temporarily removed from DOM\n            await Promise.resolve();\n\n            if (this.isConnected) {\n                return;\n            }\n\n            const callbacks = (this as unknown as InternalInstance)[callbacksProp];\n\n            let callback = callbacks.pop();\n            while (callback) {\n\n                if (callback[0] === CallbackName.disconnected) {\n                    callback[1](this);\n                }\n\n                callback = callbacks.pop();\n            }\n\n            super.disconnectedCallback!();\n\n            this.#initialized = false;\n        }\n\n        attributeChangedCallback(name: string, oldVal: string, newVal: string) {\n\n            if (!this.#initialized) {\n                return;\n            }\n\n            const prop = lookupAttributeProp(name, internalClass)!;\n\n            if (newVal == null && !(this as any)[prop[0]]) {\n                return;\n            }\n\n            (this as any)[prop[0]] = fromAttributeValue(newVal, prop[1]);\n        }\n    }\n\n    const reactiveProps = (ElementClass as unknown as InternalClass)[reactivePropsProp];\n    for (let [propName, propDefinition] of Object.entries(reactiveProps)) {\n        if (!propDefinition.attribute) {\n            propDefinition.attribute = toAttributeName(propName);\n        }\n    }\n\n    if (internalClass[globalStylesProp]) {\n        for (const css of internalClass[globalStylesProp]) {\n            if (css) {\n                const head = document.head ?? document.querySelector(\"head\");\n                const style = document.createElement(\"style\")\n                style.appendChild(document.createTextNode(css));\n                head.appendChild(style);\n            }\n        }\n    }\n\n    return finalClass;\n}\n\nfunction lookupContext(el: HTMLElement) {\n\n    if (el.assignedSlot && (el.assignedSlot as any as InternalInstance)[ownerProp]) {\n        return (el.assignedSlot as any as InternalInstance)[ownerProp];\n    }\n\n    let next = el.parentNode;\n    while (next && !(next as any as InternalInstance)[ownerProp] && !((next as Element).assignedSlot && ((next as Element).assignedSlot as any as InternalInstance)[ownerProp])) {\n        next = next.parentNode;\n    }\n\n    return next && (next as Element).assignedSlot ? ((next as Element).assignedSlot as any as InternalInstance)[ownerProp] : (el as any as InternalInstance)[ownerProp];\n}\n\nfunction lookupAttributeProp(attributeName: string, elementClass: InternalClass): [propName: string, propDefinition: CustomElementReactivePropConfig] | undefined {\n    const props = elementClass[reactivePropsProp];\n    return Object.entries(props).find(([propName, prop]) => propName === attributeName || (prop as CustomElementReactivePropConfig).attribute === attributeName);\n}\n\nfunction initReactiveProps(element: HTMLElement & CustomElementInterface & InternalInstance, elementClass: InternalClass) {\n\n    const reactiveProps = elementClass[reactivePropsProp];\n    const names = [childrenProp, ...Object.keys(reactiveProps ?? {})];\n    const preValues = element[preValuesProp];\n\n    function firePropChange(propName: string, newVal: any, oldVal: any) {\n\n        const callbacks = element[callbacksProp];\n        for (let i = 0; i < callbacks.length; i++) {\n            if (callbacks[i][0] === CallbackName.propertyValueChange) {\n                try {\n                    callbacks[i][1](element, propName, newVal, oldVal);\n                } catch (e) {\n                    console.warn(\"CustomElement property value change callback error\", e);\n                }\n            }\n        }\n\n    }\n\n    function reflectAttribute(prop: CustomElementReactivePropConfig, value: any) {\n\n        const attr = prop.attribute!;\n        value = toAttributeValue(value, prop);\n\n        if (value === undefined || value === null || value === false) {\n            element.removeAttribute(attr);\n        } else {\n            const prev = element.getAttribute(attr);\n            if (prev !== value) {\n                element.setAttribute(attr, value);\n            }\n        }\n    }\n\n    for (let i = 0; i < names.length; i++) {\n\n        const propName = names[i];\n        const propConfig = reactiveProps[propName];\n\n        let initialValue = undefined;\n        if (preValues && propName in preValues) {\n            initialValue = preValues[propName];\n        } else {\n            initialValue = (element as any)[propName];\n        }\n\n        if (propConfig?.reflect) {\n            reflectAttribute(propConfig, initialValue);\n        }\n\n        const [get, set] = createSignal(initialValue);\n\n        Object.defineProperty(element, propName, {\n            get,\n            set(newVal: any) {\n                set((oldVal: any) => {\n\n                    if (propName !== childrenProp) {\n\n                        if (propConfig?.reflect) {\n                            reflectAttribute(propConfig, newVal);\n                        }\n\n                        firePropChange(propName, newVal, oldVal);\n                    }\n\n                    return newVal;\n                })\n            },\n            enumerable: true,\n            configurable: true\n        })\n    }\n\n\n}\n"],"names":["buildFinalClass","ElementClass","internalClass","finalClass","CustomElementFinal","observedAttributes","props","reactivePropsProp","Object","values","map","p","attribute","constructor","connectedCallback","internalThis","initReactiveProps","preValuesProp","undefined","createRoot","dispose","addDisconnectedCallback","renderRoot","textContent","ownerProp","template","children","childrenProp","stylesProp","_$effect","join","getOwner","insert","lookupContext","disconnectedCallback","Promise","resolve","isConnected","callbacks","callbacksProp","callback","pop","CallbackName","disconnected","attributeChangedCallback","name","oldVal","newVal","prop","lookupAttributeProp","fromAttributeValue","reactiveProps","propName","propDefinition","entries","toAttributeName","globalStylesProp","css","head","document","querySelector","style","createElement","appendChild","createTextNode","el","assignedSlot","next","parentNode","attributeName","elementClass","find","element","names","keys","preValues","firePropChange","i","length","propertyValueChange","e","console","warn","reflectAttribute","value","attr","toAttributeValue","removeAttribute","prev","getAttribute","setAttribute","propConfig","initialValue","reflect","get","set","createSignal","defineProperty","enumerable","configurable"],"mappings":"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"}