{"version":3,"file":"buildFinalClass.js","sources":["../../src/lib/internals/buildFinalClass.tsx"],"sourcesContent":["import {AssignableType} from \"@co.mmons/js-utils/core\";\nimport {createRoot, createSignal, getOwner} from \"solid-js\";\nimport {insert} from \"solid-js/web\";\nimport {CustomElement} from \"../customElement\";\nimport {CustomElementBirthmark} from \"../customElementBirthmark\";\nimport {CustomElementInterface} from \"../CustomElementInterface\";\nimport {CustomElementReactivePropConfig} from \"../CustomElementReactivePropConfig\";\nimport {CallbackName} from \"./CallbackName\";\nimport {callbacksProp} from \"./callbacksProp\";\nimport {childrenProp} from \"./childrenProp\";\nimport {fromAttributeValue} from \"./fromAttributeValue\";\nimport {globalStylesProp} from \"./globalStylesProp\";\nimport {InternalClass} from \"./InternalClass\";\nimport {InternalInstance} from \"./InternalInstance\";\nimport {ownerProp} from \"./ownerProp\";\nimport {preValuesProp} from \"./preValuesProp\";\nimport {reactivePropsProp} from \"./reactivePropsProp\";\nimport {stylesProp} from \"./stylesProp\";\nimport {toAttributeName} from \"./toAttributeName\";\nimport {toAttributeValue} from \"./toAttributeValue\";\n\nexport function buildFinalClass(ElementClass: AssignableType<CustomElement> & CustomElementBirthmark): typeof ElementClass {\n\n    const internalClass = ElementClass as unknown as InternalClass;\n\n    const finalClass = class CustomElementFinal extends ElementClass {\n\n        static get observedAttributes() {\n            const props = internalClass[reactivePropsProp];\n            return Object.values(props).map(p => p.attribute);\n        }\n\n        constructor() {\n            super();\n        }\n\n        #initialized = false;\n\n        connectedCallback() {\n\n            const internalThis = this as unknown as HTMLElement & InternalInstance & CustomElementInterface;\n\n            if (this.#initialized) {\n                return;\n            }\n\n            this.#initialized = true;\n\n            initReactiveProps(internalThis, internalClass);\n            internalThis[preValuesProp] = undefined;\n\n            super.connectedCallback!();\n\n            createRoot((dispose: Function) => {\n\n                this.addDisconnectedCallback(() => {\n                    this.renderRoot.textContent = \"\";\n                    dispose();\n                    delete internalThis[ownerProp];\n                })\n\n                let template = super.template!({children: internalThis[childrenProp]});\n                if (template && internalClass[stylesProp] && this.renderRoot !== this) {\n                    template = <><style innerHTML={internalClass[stylesProp].join(\"\\n\")}/>{template}</>\n                }\n\n                internalThis[ownerProp] = getOwner()!;\n\n                return insert(this.renderRoot, template);\n            }, lookupContext(this));\n        }\n\n        async disconnectedCallback() {\n\n            // prevent premature releasing when element is only temporarily removed from DOM\n            await Promise.resolve();\n\n            if (this.isConnected) {\n                return;\n            }\n\n            const callbacks = (this as unknown as InternalInstance)[callbacksProp];\n\n            let callback = callbacks.pop();\n            while (callback) {\n\n                if (callback[0] === CallbackName.disconnected) {\n                    callback[1](this);\n                }\n\n                callback = callbacks.pop();\n            }\n\n            super.disconnectedCallback!();\n\n            this.#initialized = false;\n        }\n\n        attributeChangedCallback(name: string, oldVal: string, newVal: string) {\n\n            if (!this.#initialized) {\n                return;\n            }\n\n            const prop = lookupAttributeProp(name, internalClass)!;\n\n            if (newVal == null && !(this as any)[prop[0]]) {\n                return;\n            }\n\n            (this as any)[prop[0]] = fromAttributeValue(newVal, prop[1]);\n        }\n    }\n\n    const reactiveProps = (ElementClass as unknown as InternalClass)[reactivePropsProp];\n    for (let [propName, propDefinition] of Object.entries(reactiveProps)) {\n        if (!propDefinition.attribute) {\n            propDefinition.attribute = toAttributeName(propName);\n        }\n    }\n\n    if (internalClass[globalStylesProp]) {\n        for (const css of internalClass[globalStylesProp]) {\n            if (css) {\n                const head = document.head ?? document.querySelector(\"head\");\n                const style = document.createElement(\"style\")\n                style.appendChild(document.createTextNode(css));\n                head.appendChild(style);\n            }\n        }\n    }\n\n    return finalClass;\n}\n\nfunction lookupContext(el: HTMLElement) {\n\n    if (el.assignedSlot && (el.assignedSlot as any as InternalInstance)[ownerProp]) {\n        return (el.assignedSlot as any as InternalInstance)[ownerProp];\n    }\n\n    let next = el.parentNode;\n    while (next && !(next as any as InternalInstance)[ownerProp] && !((next as Element).assignedSlot && ((next as Element).assignedSlot as any as InternalInstance)[ownerProp])) {\n        next = next.parentNode;\n    }\n\n    return next && (next as Element).assignedSlot ? ((next as Element).assignedSlot as any as InternalInstance)[ownerProp] : (el as any as InternalInstance)[ownerProp];\n}\n\nfunction lookupAttributeProp(attributeName: string, elementClass: InternalClass): [propName: string, propDefinition: CustomElementReactivePropConfig] | undefined {\n    const props = elementClass[reactivePropsProp];\n    return Object.entries(props).find(([propName, prop]) => propName === attributeName || (prop as CustomElementReactivePropConfig).attribute === attributeName);\n}\n\nfunction initReactiveProps(element: HTMLElement & CustomElementInterface & InternalInstance, elementClass: InternalClass) {\n\n    const reactiveProps = elementClass[reactivePropsProp];\n    const names = [childrenProp, ...Object.keys(reactiveProps ?? {})];\n    const preValues = element[preValuesProp];\n\n    function firePropChange(propName: string, newVal: any, oldVal: any) {\n\n        const callbacks = element[callbacksProp];\n        for (let i = 0; i < callbacks.length; i++) {\n            if (callbacks[i][0] === CallbackName.propertyValueChange) {\n                try {\n                    callbacks[i][1](element, propName, newVal, oldVal);\n                } catch (e) {\n                    console.warn(\"CustomElement property value change callback error\", e);\n                }\n            }\n        }\n\n    }\n\n    function reflectAttribute(prop: CustomElementReactivePropConfig, value: any) {\n\n        const attr = prop.attribute!;\n        value = toAttributeValue(value, prop);\n\n        if (value === undefined || value === null || value === false) {\n            element.removeAttribute(attr);\n        } else {\n            const prev = element.getAttribute(attr);\n            if (prev !== value) {\n                element.setAttribute(attr, value);\n            }\n        }\n    }\n\n    for (let i = 0; i < names.length; i++) {\n\n        const propName = names[i];\n        const propConfig = reactiveProps[propName];\n\n        let initialValue = undefined;\n        if (preValues && propName in preValues) {\n            initialValue = preValues[propName];\n        } else {\n            initialValue = (element as any)[propName];\n        }\n\n        if (propConfig?.reflect) {\n            reflectAttribute(propConfig, initialValue);\n        }\n\n        const [get, set] = createSignal(initialValue);\n\n        Object.defineProperty(element, propName, {\n            get,\n            set(newVal: any) {\n                set((oldVal: any) => {\n\n                    if (propName !== childrenProp) {\n\n                        if (propConfig?.reflect) {\n                            reflectAttribute(propConfig, newVal);\n                        }\n\n                        firePropChange(propName, newVal, oldVal);\n                    }\n\n                    return newVal;\n                })\n            },\n            enumerable: true,\n            configurable: true\n        })\n    }\n\n\n}\n"],"names":["buildFinalClass","ElementClass","_initialized","internalClass","finalClass","_classPrivateFieldLooseKey","observedAttributes","props","reactivePropsProp","Object","values","map","p","attribute","constructor","connectedCallback","internalThis","_classPrivateFieldLooseBase","initReactiveProps","preValuesProp","undefined","createRoot","dispose","addDisconnectedCallback","renderRoot","textContent","ownerProp","template","children","childrenProp","stylesProp","_el$","_tmpl$","_$effect","join","getOwner","insert","lookupContext","disconnectedCallback","Promise","resolve","isConnected","callbacks","callbacksProp","callback","pop","CallbackName","disconnected","attributeChangedCallback","name","oldVal","newVal","prop","lookupAttributeProp","fromAttributeValue","reactiveProps","propName","propDefinition","entries","toAttributeName","globalStylesProp","css","head","document","querySelector","style","createElement","appendChild","createTextNode","el","assignedSlot","next","parentNode","attributeName","elementClass","find","element","names","keys","preValues","firePropChange","i","length","propertyValueChange","e","console","warn","reflectAttribute","value","attr","toAttributeValue","removeAttribute","getAttribute","setAttribute","propConfig","initialValue","reflect","get","set","createSignal","defineProperty","enumerable","configurable"],"mappings":"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"}